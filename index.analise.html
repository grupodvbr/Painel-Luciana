<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel de Receitas & Lucratividade</title>
<style>
  :root{
    --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f0f0f0; --muted:#cfcfcf;
    --brand:#2563eb; --ghost:#374151; --accent:#b75507; --good:#16a34a; --bad:#b91c1c;
  }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:24px}
  h1{margin:0 0 8px}
  .muted{color:#cfcfcf}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 4px 20px rgba(0,0,0,.3)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button{border-radius:10px;border:1px solid #333;background:#0f0f10;color:#fff;padding:10px}
  button.btn{background:var(--brand);border:0;cursor:pointer}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:8px}
  th{background:#000}
  .right{text-align:right}
  .badge{border:1px solid #374151;border-radius:999px;padding:2px 6px;font-size:.75rem}
  .ok{color:var(--good)} .bad{color:var(--bad)}
  .mini{padding:6px 10px}
  .table-wrap{overflow:auto}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .kpi .card{margin:0}
  @media (max-width: 900px){ .kpi{grid-template-columns:1fr 1fr} }

  /* Modais */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{width:100%;max-width:900px;background:#121212;border:1px solid var(--line);border-radius:14px;padding:16px}
  .modal .box small{color:#aaa}
</style>
</head>
<body>
  <h1>Painel de Receitas & Lucratividade</h1>
  <div class="muted">Acompanhe custos, preços e margens. Edite o preço de venda diretamente na tabela.</div>

  <div class="card toolbar">
    <input id="busca" placeholder="Buscar por item ou classificação..." style="flex:1">
    <select id="filtroUM">
      <option value="">U.M. do rendimento (todas)</option>
      <option value="kg">kg/L (g,kg,ml,l)</option>
      <option value="un">un</option>
    </select>
    <select id="filtroClass"></select>
    <button class="btn mini" id="recarregar">Recarregar</button>
    <button class="btn mini" id="btnHistorico">Histórico</button>
  </div>

  <div class="kpi">
    <div class="card"><div class="muted">Produtos</div><div id="kpiProdutos" style="font-size:1.6rem;font-weight:bold">—</div></div>
    <div class="card"><div class="muted">Custo médio unitário</div><div id="kpiCustoMedio" style="font-size:1.6rem;font-weight:bold">—</div></div>
    <div class="card"><div class="muted">Preço médio</div><div id="kpiPrecoMedio" style="font-size:1.6rem;font-weight:bold">—</div></div>
    <div class="card"><div class="muted">Margem média</div><div id="kpiMargemMedia" style="font-size:1.6rem;font-weight:bold">—</div></div>
  </div>

  <div class="card table-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>Item</th>
          <th>Classificação</th>
          <th>Rendimento</th>
          <th>U.M.</th>
          <th class="right">Custo Receita</th>
          <th class="right">Custo Unit. (kg/L ou un)</th>
          <th class="right">Preço Venda (R$)</th>
          <th class="right">Margem</th>
          <th class="right">Sugestão (+30%)</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal de Histórico -->
  <div class="modal" id="modalHist">
    <div class="box">
      <h3>Histórico de alterações</h3>
      <div class="toolbar" style="margin:8px 0">
        <input id="buscaHist" placeholder="Buscar por item, entidade, ação, usuário ou campo alterado..." style="flex:1">
        <select id="filtroEnt"><option value="">Entidade (todas)</option></select>
        <select id="filtroAcao"><option value="">Ação (todas)</option></select>
        <button class="mini" id="btnAtualizarHist">Atualizar</button>
      </div>
      <div class="table-wrap">
        <table id="tblHist">
          <thead>
            <tr>
              <th>Quando</th><th>Usuário</th><th>Entidade</th><th>Ação</th><th>Chave</th><th>Campos alterados</th><th>Ver</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="text-align:right;margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="mini" id="abrirAbaHistorico">Abrir na planilha</button>
        <button class="mini" onclick="closeHist()">Fechar</button>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwIQn3iQ7k901KhVjpWJntwLA4-Gv2zqzzS-DlANpt8jTyPocZIWohbgHf19PY5ANL3/exec';

/* ====== ESTADO ====== */
let DATA = [];

/* ====== HELPERS ====== */
const tbody = document.querySelector('#tbl tbody');
const fmtBRL = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtPct = v => isFinite(v) ? (v*100).toFixed(1).replace('.',',')+'%' : '—';
const pad2 = n => String(n).padStart(2,'0');
const fmtTS = (ts) => {
  try{
    const d = new Date(ts);
    const dia = pad2(d.getDate()), mes = pad2(d.getMonth()+1), ano = d.getFullYear();
    const hh = pad2(d.getHours()), mm = pad2(d.getMinutes());
    return `${dia}/${mes}/${ano} - ${hh}:${mm}`;
  }catch(e){ return String(ts||''); }
};
function toast(m){
  let t = document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast';
  Object.assign(t.style,{position:'fixed',left:'50%',bottom:'20px',transform:'translateX(-50%)',background:'#111',border:'1px solid #333',padding:'8px 12px',borderRadius:'10px',zIndex:99});
  document.body.appendChild(t); }
  t.textContent=m; t.style.opacity=1; clearTimeout(t._t); t._t=setTimeout(()=>t.style.opacity=0,1600);
}

/* ====== FETCH ====== */
async function fetchProdutos(){
  const url = WEBAPP_URL + '?action=produtos&ts=' + Date.now();
  const r = await fetch(url, { cache:'no-store' });
  const j = await r.json();
  if(!j.ok){ toast('Erro ao carregar produtos'); console.warn(j.error); return []; }
  return j.data || [];
}
async function salvarPrecoRemoto(id, preco){
  const r = await fetch(WEBAPP_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ type:'update_preco', payload:{ id, precoVenda: preco } })
  });
  return r.json();
}

/* ====== FILTROS & KPIs ====== */
function renderClassFilter(){
  const sel = document.getElementById('filtroClass');
  const classes = Array.from(new Set(DATA.map(d=>d.classificacao).filter(Boolean))).sort();
  sel.innerHTML = '<option value="">Classificação (todas)</option>' + classes.map(c=>`<option>${c}</option>`).join('');
}
function filtrar(){
  const q = (document.getElementById('busca').value||'').toLowerCase();
  const fUM = document.getElementById('filtroUM').value;
  const fC  = document.getElementById('filtroClass').value;
  return DATA.filter(d=>{
    const hitQ = (d.item||'').toLowerCase().includes(q) || (d.classificacao||'').toLowerCase().includes(q);
    const hitUM = !fUM || (fUM==='un' ? d.unidadeRend==='un' : (d.unidadeRend!=='un'));
    const hitC = !fC || d.classificacao===fC;
    return hitQ && hitUM && hitC;
  });
}
function custoUnitarioBase(d){
  if(['g','kg','ml','l'].includes(d.unidadeRend)) return d.custoPorKgOuL;
  if(d.unidadeRend==='un' && d.rendimento>0) return d.custoReceita / d.rendimento;
  return 0;
}

/* ====== TABELA ====== */
function renderTabela(){
  const arr = filtrar();
  tbody.innerHTML = arr.map(d=>{
    const cUnit = custoUnitarioBase(d);
    const margemTxt = d.precoVenda>0 && cUnit>0 ? fmtPct((d.precoVenda - cUnit)/d.precoVenda) : '—';
    const margemCls = (d.precoVenda>0 && cUnit>0 && (d.precoVenda - cUnit)/d.precoVenda >= 0.3) ? 'ok' : 'bad';
    const umLabel = d.unidadeRend==='un' ? 'un' : 'kg/L';
    return `
      <tr data-id="${d.id}">
        <td>${d.item||''}<div class="muted" style="font-size:.8rem">${d.codigoSistema||''}</div></td>
        <td>${d.classificacao||''}</td>
        <td class="right">${d.rendimento||0}</td>
        <td><span class="badge">${d.unidadeRend||''}</span></td>
        <td class="right">${fmtBRL(d.custoReceita||0)}</td>
        <td class="right" title="Base: ${umLabel}">${fmtBRL(cUnit||0)}</td>
        <td class="right"><input class="preco" type="number" step="0.0001" value="${d.precoVenda||''}" style="width:120px;text-align:right"></td>
        <td class="right ${d.precoVenda?margemCls:''}">${margemTxt}</td>
        <td class="right">${d.precoSugerido?fmtBRL(d.precoSugerido):'—'}</td>
        <td>
          <button class="mini ver">Ver receita</button>
          <button class="mini salvar">Salvar preço</button>
        </td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="10" class="muted">Nada encontrado.</td></tr>`;

  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    const id = Number(tr.dataset.id);
    tr.querySelector('.ver').addEventListener('click', ()=>openModalReceita(id));
    tr.querySelector('.salvar').addEventListener('click', async ()=>{
      const inp = tr.querySelector('.preco');
      const v = Number(inp.value||0);
      const j = await salvarPrecoRemoto(id, v);
      if(j.ok){ const d = DATA.find(x=>x.id===id); if(d) d.precoVenda=v; toast('Preço salvo ✓'); renderTabela(); }
      else { toast('Erro ao salvar'); console.warn(j.error); }
    });
    tr.querySelector('.preco').addEventListener('input', ()=> atualizarKPIs());
  });

  atualizarKPIs();
}
function atualizarKPIs(){
  const arr = filtrar();
  const n = arr.length;
  document.getElementById('kpiProdutos').textContent = n;
  if(!n){ ['kpiCustoMedio','kpiPrecoMedio','kpiMargemMedia'].forEach(id=>document.getElementById(id).textContent='—'); return; }
  const custos = arr.map(custoUnitarioBase).filter(v=>v>0);
  const precos = arr.map(d=>{
    const tr = tbody.querySelector(`tr[data-id="${d.id}"]`);
    const v = tr ? Number(tr.querySelector('.preco').value||0) : Number(d.precoVenda||0);
    return v||0;
  }).filter(v=>v>0);
  const media = a => a.length ? a.reduce((s,v)=>s+v,0)/a.length : 0;
  const mCusto = media(custos), mPreco=media(precos);
  const ms=[]; arr.forEach(d=>{ const c=custoUnitarioBase(d); const tr=tbody.querySelector(`tr[data-id="${d.id}"]`); const p=tr?Number(tr.querySelector('.preco').value||0):Number(d.precoVenda||0); if(c>0&&p>0) ms.push((p-c)/p); });
  const mMargem = media(ms);
  document.getElementById('kpiCustoMedio').textContent = mCusto?fmtBRL(mCusto):'—';
  document.getElementById('kpiPrecoMedio').textContent = mPreco?fmtBRL(mPreco):'—';
  document.getElementById('kpiMargemMedia').textContent = ms.length?fmtPct(mMargem):'—';
}

/* ====== MODAL RECEITA (resumo simples – mantido) ====== */
function openModalReceita(id){
  alert('Abrir modal de receita do produto ' + id + ' (mantive simplificado aqui).');
}

/* ====== HISTÓRICO ====== */
const modalHist = document.getElementById('modalHist');
const tblHistBody = document.querySelector('#tblHist tbody');
let HIST_CACHE = [];

function openHist(){
  modalHist.style.display='flex';
  if(!HIST_CACHE.length) carregarHistorico();
}
function closeHist(){ modalHist.style.display='none'; }

async function carregarHistorico(){
  try{
    const r = await fetch(WEBAPP_URL + '?action=historico&limit=300&ts=' + Date.now(), {cache:'no-store'});
    const j = await r.json();
    if(j.ok){
      HIST_CACHE = j.data || [];
      renderHistorico();
      preencherFiltrosHistorico();
    } else {
      toast('Erro ao carregar histórico');
    }
  }catch(e){
    console.error(e);
    toast('Falha ao carregar histórico');
  }
}
function preencherFiltrosHistorico(){
  const ent = Array.from(new Set(HIST_CACHE.map(h=>h.entidade).filter(Boolean))).sort();
  const ac  = Array.from(new Set(HIST_CACHE.map(h=>h.acao).filter(Boolean))).sort();
  document.getElementById('filtroEnt').innerHTML =
    '<option value="">Entidade (todas)</option>' + ent.map(x=>`<option>${x}</option>`).join('');
  document.getElementById('filtroAcao').innerHTML =
    '<option value="">Ação (todas)</option>' + ac.map(x=>`<option>${x}</option>`).join('');
}
function filtrarHistorico(){
  const q = (document.getElementById('buscaHist').value||'').toLowerCase();
  const fEnt = document.getElementById('filtroEnt').value;
  const fAcao = document.getElementById('filtroAcao').value;
  return (HIST_CACHE||[]).filter(h=>{
    const campos = Object.keys(h.diff||{}).join(' ').toLowerCase();
    const blob = [h.usuario,h.entidade,h.acao,h.chave,campos].join(' ').toLowerCase();
    const hitQ = !q || blob.includes(q);
    const hitE = !fEnt || h.entidade===fEnt;
    const hitA = !fAcao || h.acao===fAcao;
    return hitQ && hitE && hitA;
  });
}
function renderHistorico(){
  const rows = filtrarHistorico();
  tblHistBody.innerHTML = rows.map((h,idx)=>{
    const campos = Object.keys(h.diff||{});
    const chips = campos.length ? campos.slice(0,6).map(c=>`<span class="badge">${c}</span>`).join(' ') +
      (campos.length>6 ? ` <span class="badge">+${campos.length-6}</span>`:'') : '<span class="badge">—</span>';
    return `
      <tr data-i="${idx}">
        <td>${fmtTS(h.quando||h.timestamp||h.ts)}</td>
        <td>${h.usuario||''}</td>
        <td>${h.entidade||''}</td>
        <td>${h.acao||''}</td>
        <td>${h.chave||''}</td>
        <td>${chips}</td>
        <td class="right"><button class="mini verJson">ver</button></td>
      </tr>
      <tr class="det" data-i="${idx}" style="display:none;background:#0f0f10">
        <td colspan="7">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div><div class="muted" style="margin-bottom:4px">Antes</div><pre style="margin:0;white-space:pre-wrap">${escapeHtml(JSON.stringify(h.antes||{},null,2))}</pre></div>
            <div><div class="muted" style="margin-bottom:4px">Depois</div><pre style="margin:0;white-space:pre-wrap">${escapeHtml(JSON.stringify(h.depois||{},null,2))}</pre></div>
          </div>
          <div style="margin-top:8px"><div class="muted" style="margin-bottom:4px">Diff</div><pre style="margin:0;white-space:pre-wrap">${escapeHtml(JSON.stringify(h.diff||{},null,2))}</pre></div>
        </td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="7" class="muted">Nenhuma alteração encontrada.</td></tr>`;

  // toggles
  tblHistBody.querySelectorAll('.verJson').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i = btn.closest('tr').dataset.i;
      const det = tblHistBody.querySelector(`tr.det[data-i="${i}"]`);
      det.style.display = det.style.display==='none' ? '' : 'none';
    });
  });
}
function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

/* ====== Binds ====== */
document.getElementById('btnHistorico').addEventListener('click', openHist);
document.getElementById('btnAtualizarHist').addEventListener('click', carregarHistorico);
document.getElementById('buscaHist').addEventListener('input', renderHistorico);
document.getElementById('filtroEnt').addEventListener('change', renderHistorico);
document.getElementById('filtroAcao').addEventListener('change', renderHistorico);
document.getElementById('abrirAbaHistorico').addEventListener('click', async ()=>{
  try{
    const r = await fetch(WEBAPP_URL + '?action=historico_link&ts=' + Date.now(), {cache:'no-store'});
    const j = await r.json();
    if(j.ok && j.url) window.open(j.url,'_blank'); else toast('Não consegui abrir a planilha.');
  }catch(e){ toast('Falha ao abrir a planilha.'); }
});
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeHist(); }});

/* ====== Boot (produtos) ====== */
document.getElementById('recarregar').addEventListener('click', async ()=>{
  DATA = await fetchProdutos(); renderClassFilter(); renderTabela();
});
document.getElementById('busca').addEventListener('input', renderTabela);
document.getElementById('filtroUM').addEventListener('change', renderTabela);
document.getElementById('filtroClass').addEventListener('change', renderTabela);

(async function init(){
  DATA = await fetchProdutos();
  renderClassFilter();
  renderTabela();
})();
</script>
</body>
</html>
