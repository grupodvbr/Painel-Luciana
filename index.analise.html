<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel de Análise • Receitas</title>
<style>
  :root{ --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f0f0f0; --muted:#cfcfcf; --brand:#2563eb; --ghost:#374151; --accent:#b75507; }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:24px}
  h1{margin:0 0 16px}
  a{color:#93c5fd}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 4px 20px rgba(0,0,0,.3)}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  label{font-size:.85rem;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#0f0f10;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid var(--line);padding:8px;text-align:left}
  th{background:#000}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;background:var(--brand);color:#fff}
  .btn.ghost{background:transparent;border:1px solid var(--ghost)}
  .btn.secondary{background:#334155}
  .right{text-align:right}
  .muted{opacity:.85}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--ghost);font-size:.8rem;background:#111}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .small{font-size:.9rem}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f172a;border:1px solid #334155;color:#cbd5e1;font-size:.75rem}
  .link{cursor:pointer;color:#93c5fd}

  /* Modal de Detalhes */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{width:100%;max-width:980px;max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .modal header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .foto{width:120px;height:120px;object-fit:cover;border-radius:12px;border:1px solid var(--line)}

  /* tabela responsiva no modal */
  .tbl-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}

  /* mobile */
  @media (max-width: 768px){
    body{padding:12px}
    .row{grid-template-columns:1fr;gap:10px}
  }
</style>
</head>
<body>
  <h1>Painel de Análise de Receitas</h1>

  <div class="card">
    <div class="row">
      <div style="grid-column: span 3">
        <label>Empresa</label>
        <select id="fEmpresa"><option value="">(Todas)</option></select>
      </div>
      <div style="grid-column: span 4">
        <label>Buscar</label>
        <input id="fBusca" placeholder="Item, classificação, código...">
      </div>
      <div style="grid-column: span 3;align-self:end" class="right">
        <button class="btn ghost" id="btnAtualizar">Atualizar</button>
      </div>
    </div>
    <div id="metaInfo" class="small muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <table id="tblReceitas">
      <thead>
        <tr>
          <th>Empresa</th>
          <th>Código</th>
          <th>Nº</th>
          <th>Item</th>
          <th>Classificação</th>
          <th>Rendimento</th>
          <th>U.M.</th>
          <th class="right">Custo da Receita</th>
          <th class="right">Custo por kg/L</th>
          <th>Data</th>
          <th>Usuário</th>
        </tr>
      </thead>
      <tbody id="tbodyReceitas"></tbody>
    </table>
  </div>

  <!-- Modal Detalhes -->
  <div class="modal" id="modal">
    <div class="box">
      <header>
        <div>
          <div id="mTitulo" style="font-weight:700;font-size:1.1rem"></div>
          <div id="mSub" class="small muted"></div>
        </div>
        <div class="inline">
          <label class="small">Comparar com</label>
          <select id="mCompare"></select>
          <button class="btn ghost" id="mFechar">Fechar</button>
        </div>
      </header>

      <div class="row" style="margin-bottom:12px">
        <div style="grid-column: span 9">
          <div class="pill" id="mResumo"></div>
        </div>
        <div style="grid-column: span 3" class="right">
          <img id="mFoto" class="foto" alt="foto" style="display:none"/>
        </div>
      </div>

      <div class="tbl-wrap">
        <table id="tblDet">
          <thead>
            <tr>
              <th>Ingrediente</th>
              <th class="right">Qtd</th>
              <th>U.M.</th>
              <th class="right">Preço (empresa)</th>
              <th class="right">Preço (comparar)</th>
              <th class="right">Diferença</th>
            </tr>
          </thead>
          <tbody id="tbodyDet"></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:12px">
        <div style="grid-column: span 6">
          <span class="pill" id="mTotalA"></span>
        </div>
        <div style="grid-column: span 6" class="right">
          <span class="pill" id="mTotalB"></span>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const WEBAPP_URL = 'COLE_AQUI_SUA_URL_DO_GAS'; // <<< ajuste

/* ===== ESTADO ===== */
let PRODUTOS = [];         // todos os produtos (de todas as empresas)
let ING_TODOS = [];        // todos os ingredientes (de todas as empresas)
let EMPRESAS = [];         // lista de empresas únicas
let EMPRESA_ATUAL = '';

/* ===== HELPERS ===== */
const tbodyR = document.getElementById('tbodyReceitas');
const fmtBRL = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const FACTOR = { g:1, kg:1000, ml:1, l:1000, un:1 };
const TYPE   = u => (u==='g'||u==='kg')?'mass' : (u==='ml'||u==='l')?'vol' : 'count';
function convertQty(qty, from, to){ from=(from||'').toLowerCase(); to=(to||'').toLowerCase(); if(!FACTOR[from]||!FACTOR[to]) return qty; if(TYPE(from)!==TYPE(to)) return NaN; return qty*(FACTOR[from]/FACTOR[to]); }
function norm(s){ return String(s||'').trim().toLowerCase(); }

/* ===== GAS ===== */
async function apiGet(path){ const r = await fetch(WEBAPP_URL+path, {cache:'no-store'}); return r.json(); }
async function carregarEmpresas(){
  // tenta endpoint dedicado; senão deduz de produtos+ingredientes
  try{ const j = await apiGet('?action=empresas&ts='+Date.now()); if(j.ok && Array.isArray(j.data) && j.data.length){ EMPRESAS = j.data.filter(Boolean); return; } }catch(_){ }
  const [p,i] = await Promise.all([ apiGet('?action=produtos&ts='+Date.now()), apiGet('?action=ingredientes&ts='+Date.now()) ]);
  const set = new Set();
  if(p.ok) (p.data||[]).forEach(r=>{ if(r.empresa) set.add(r.empresa); });
  if(i.ok) (i.data||[]).forEach(r=>{ if(r.empresa) set.add(r.empresa); });
  EMPRESAS = [...set];
}
async function carregarDados(){
  const [p,i] = await Promise.all([
    apiGet('?action=produtos&ts='+Date.now()),
    apiGet('?action=ingredientes&ts='+Date.now())
  ]);
  PRODUTOS = p.ok ? (p.data||[]) : [];
  ING_TODOS = i.ok ? (i.data||[]) : [];
}

/* ===== RENDER LISTA ===== */
function renderEmpresasSelect(){
  const sel = document.getElementById('fEmpresa'); sel.innerHTML = '<option value="">(Todas)</option>' + EMPRESAS.map(e=>`<option value="${e}">${e}</option>`).join('');
  if(EMPRESA_ATUAL){ sel.value = EMPRESA_ATUAL; }
}
function renderTabela(){
  const busca = norm(document.getElementById('fBusca').value);
  const emp = document.getElementById('fEmpresa').value;
  EMPRESA_ATUAL = emp;
  const arr = (PRODUTOS||[]).filter(r=>{
    const empOk = !emp || norm(r.empresa)===norm(emp);
    const bOk = !busca || [r.item,r.classificacao,r.codigoSistema,r.numero].some(v=> String(v||'').toLowerCase().includes(busca));
    return empOk && bOk;
  });
  tbodyR.innerHTML = '';
  arr.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="tag">${r.empresa||'-'}</span></td>
      <td>${r.codigoSistema||''}</td>
      <td>${r.numero||''}</td>
      <td><span class="link" data-idx="${idx}">${r.item||''}</span></td>
      <td>${r.classificacao||''}</td>
      <td>${r.rendimento||''}</td>
      <td>${(r.unidadeRend||'').toUpperCase()}</td>
      <td class="right">${fmtBRL(Number(r.custoReceita||0))}</td>
      <td class="right">${fmtBRL(Number(r.custoPorKgOuL||0))}</td>
      <td>${r.data||''}</td>
      <td>${r.usuario||''}</td>`;
    tbodyR.appendChild(tr);
  });
  // click nos itens
  tbodyR.querySelectorAll('.link').forEach(a=> a.addEventListener('click', (e)=>{
    const idx = Number(e.target.dataset.idx);
    const listaFiltrada = (PRODUTOS||[]).filter(r=>{
      const empOk = !EMPRESA_ATUAL || norm(r.empresa)===norm(EMPRESA_ATUAL);
      const bOk = !busca || [r.item,r.classificacao,r.codigoSistema,r.numero].some(v=> String(v||'').toLowerCase().includes(busca));
      return empOk && bOk;
    });
    const item = listaFiltrada[idx];
    if(item) abrirModal(item);
  }));
  document.getElementById('metaInfo').textContent = `${arr.length} receitas exibidas${emp?` • Empresa: ${emp}`:''}`;
}

/* ===== COMPARAÇÃO ===== */
function indexIngredientesPorEmpresa(){
  // retorna { empresa -> { key -> ingrediente } }, key por código se houver, senão nome
  const map = {};
  (ING_TODOS||[]).forEach(x=>{
    const emp = x.empresa||''; if(!map[emp]) map[emp] = {};
    const key = x.codigo ? `#${String(x.codigo).trim()}` : `n:${norm(x.nome)}`;
    map[emp][key] = x;
  });
  return map;
}
function acharIng(map, empresa, recItem){
  const keyCod = recItem.codigo ? `#${String(recItem.codigo).trim()}` : null;
  const keyNome = `n:${norm(recItem.item)}`;
  const m = map[empresa]||{};
  return (keyCod && m[keyCod]) || m[keyNome] || null;
}
function custoLinhaEmEmpresa(recItem, ingEmpresa){
  if(!ingEmpresa) return {unit:0, subtotal:0};
  const qtd = Number(recItem.qtd||0);
  const umLinha = String(recItem.um||'').toLowerCase();
  const umPreco = String(ingEmpresa.um||'').toLowerCase();
  const qtdConv = convertQty(qtd, umLinha, umPreco);
  const unit = Number(ingEmpresa.custoUnit||0);
  const subtotal = (isNaN(qtdConv)?0:qtdConv) * unit;
  return {unit, subtotal};
}

/* ===== MODAL ===== */
const modal = document.getElementById('modal');
const mFechar = document.getElementById('mFechar');
mFechar.addEventListener('click', ()=> modal.style.display='none');

function abrirModal(prod){
  const map = indexIngredientesPorEmpresa();
  const baseEmp = prod.empresa || EMPRESA_ATUAL || '';
  // montar seletor de comparação
  const cmpSel = document.getElementById('mCompare');
  cmpSel.innerHTML = EMPRESAS.filter(e=>e!==baseEmp).map(e=>`<option value="${e}">${e}</option>`).join('');
  if(!cmpSel.value && cmpSel.firstChild) cmpSel.selectedIndex = 0;

  function render(){
    const compararCom = cmpSel.value || '';
    document.getElementById('mTitulo').textContent = `${prod.item||''}`;
    document.getElementById('mSub').textContent = `${prod.classificacao||''} • Empresa: ${baseEmp} • Nº ${prod.numero||''}`;
    const foto = document.getElementById('mFoto');
    if(prod.fotoUrl){ foto.src = prod.fotoUrl; foto.style.display='block'; } else { foto.style.display='none'; }

    const receita = Array.isArray(prod.receita) ? prod.receita : [];
    const tbody = document.getElementById('tbodyDet');
    tbody.innerHTML = '';

    let totA=0, totB=0;
    receita.forEach(r=>{
      const ingA = acharIng(map, baseEmp, r);
      const ingB = compararCom ? acharIng(map, compararCom, r) : null;
      const a = custoLinhaEmEmpresa(r, ingA);
      const b = custoLinhaEmEmpresa(r, ingB);
      totA += a.subtotal; totB += b.subtotal;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.item||''}</td>
        <td class="right">${Number(r.qtd||0)}</td>
        <td>${(r.um||'').toUpperCase()}</td>
        <td class="right">${ingA?fmtBRL(a.unit):'—'}</td>
        <td class="right">${ingB?fmtBRL(b.unit):'—'}</td>
        <td class="right">${ingA&&ingB?fmtBRL(b.unit - a.unit):'—'}</td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('mResumo').textContent = `Rendimento: ${prod.rendimento||''} ${(prod.unidadeRend||'').toUpperCase()} • Itens: ${Array.isArray(prod.receita)?prod.receita.length:0}`;
    document.getElementById('mTotalA').textContent = `Total na empresa (${baseEmp}): ${fmtBRL(totA)}`;
    document.getElementById('mTotalB').textContent = compararCom ? `Total na empresa (${compararCom}): ${fmtBRL(totB)}` : 'Selecione uma empresa para comparar';
  }

  render();
  document.getElementById('mCompare').onchange = render;
  modal.style.display='flex';
}

/* ===== BOOT ===== */
async function boot(){
  const btn = document.getElementById('btnAtualizar');
  btn.disabled = true; btn.textContent = 'Carregando...';
  await carregarEmpresas();
  await carregarDados();
  renderEmpresasSelect();
  renderTabela();
  btn.disabled = false; btn.textContent = 'Atualizar';
}

// Eventos filtros
 document.getElementById('btnAtualizar').addEventListener('click', async ()=>{ await carregarDados(); renderTabela(); });
 document.getElementById('fEmpresa').addEventListener('change', renderTabela);
 document.getElementById('fBusca').addEventListener('input', renderTabela);

boot();
</script>
</body>
</html>
