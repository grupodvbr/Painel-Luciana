<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel de Análise • Receitas</title>
<style>
  :root{
    --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f0f0f0; --muted:#cfcfcf;
    --brand:#2563eb; --ghost:#374151; --accent:#b75507;
    /* 👉 ALTERE AQUI O TAMANHO DA FOTO DO MODAL */
    --foto-size: 200px; /* ex.: 120px, 160px, 200px, 260px... */
  }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:24px}
  h1{margin:0 0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 4px 20px rgba(0,0,0,.3)}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  label{font-size:.85rem;color:var(--muted)}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#0f0f10;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
  th{background:#000}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;background:var(--brand);color:#fff}
  .btn.ghost{background:transparent;border:1px solid var(--ghost)}
  .right{text-align:right}
  .muted{opacity:.85}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--ghost);font-size:.8rem;background:#111}
  .small{font-size:.9rem}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f172a;border:1px solid #334155;color:#cbd5e1;font-size:.75rem}
  .link{cursor:pointer;color:#93c5fd}
  .best{outline:2px solid #16a34a; background:rgba(22,163,74,.12)}
  .best::after{content:" 💚";}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{width:100%;max-width:1100px;max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}

  /* ======= CABEÇALHO DO MODAL ======= */
  .modal header{
    position:relative;
    display:grid;
    grid-template-columns: 1fr auto;
    align-items:center;
    gap:12px;
    padding-top:56px; /* espaço para a barra superior fixa */
    margin-bottom:8px;
  }
  /* barra fixa no topo do popup (select + fechar) */
  .top-controls{
    position:absolute;
    top:0; right:0;
    display:flex; align-items:center; gap:8px;
    background:transparent;
  }
  .ctrl{height:40px; padding:10px 14px; border-radius:12px}
  .ctrl.w{width:220px}
  .h-mid{display:flex;align-items:center;gap:12px}

  /* 👉 A foto usa a variável --foto-size acima */
  .foto{
    width:var(--foto-size); height:var(--foto-size);
    object-fit:cover; border-radius:12px; border:1px solid var(--line);
    box-shadow:0 6px 20px rgba(0,0,0,.35);
  }

  .tbl-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}

  @media (max-width: 768px){
    body{padding:12px}
    .row{grid-template-columns:1fr;gap:10px}

    .modal header{
      grid-template-columns: 1fr;
      padding-top:0;        /* a barra deixa de ser absoluta no mobile */
    }
    .top-controls{
      position:static;      /* vira conteúdo normal no fluxo */
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .ctrl.w{width:100%}
  }
</style>
</head>
<body>
  <h1>Painel de Análise de Receitas</h1>

  <div class="card">
    <div class="row">
      <div style="grid-column: span 3">
        <label>Empresa</label>
        <select id="fEmpresa"><option value="">(Todas)</option></select>
      </div>
      <div style="grid-column: span 5">
        <label>Buscar</label>
        <input id="fBusca" placeholder="Item, classificação, código...">
      </div>
      <div style="grid-column: span 2;align-self:end" class="right">
        <button class="btn ghost" id="btnAtualizar">Atualizar</button>
      </div>
    </div>
    <div id="metaInfo" class="small muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <table id="tblReceitas">
      <thead>
        <tr>
          <th>Empresa</th><th>Código</th><th>Nº</th><th>Item</th><th>Classificação</th>
          <th>Rendimento</th><th>U.M.</th><th class="right">Custo da Receita</th>
          <th class="right">Custo por kg/L</th><th>Data</th><th>Usuário</th>
        </tr>
      </thead>
      <tbody id="tbodyReceitas"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="box">
      <header>
        <!-- barra fixa no topo do popup -->
        <div class="top-controls">
          <label class="small muted" for="mCompare">Empresas</label>
          <select id="mCompare" class="ctrl w"></select>
          <button class="btn ghost ctrl" id="mFechar">Fechar</button>
        </div>

        <!-- título + subtítulo -->
        <div>
          <div id="mTitulo" style="font-weight:700;font-size:1.1rem"></div>
          <div id="mSub" class="small muted"></div>
        </div>

        <!-- foto grande -->
        <div class="h-mid">
          <img id="mFoto" class="foto" alt="foto" style="display:none"/>
        </div>
      </header>

      <div id="mResumo" class="pill" style="margin-bottom:12px"></div>

      <div class="tbl-wrap">
        <table id="tblDet">
          <thead id="theadDet"></thead>
          <tbody id="tbodyDet"></tbody>
        </table>
      </div>

      <div id="mTotals" class="row" style="margin-top:12px"></div>
      <div id="mExplain" class="small muted" style="margin-top:6px"></div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzgAtK2XHB9l4Ddmx9tNAR-xEl194w-wwQE2kNxbVUl4ZqrOytTWJeuyXau35Qhs-e1/exec';

/* ===== ESTADO ===== */
let PRODUTOS = [];
let ING_TODOS = [];       // todos os ingredientes (todas as empresas)
let EMPRESAS = [];
let EMPRESA_ATUAL = '';

/* ===== HELPERS ===== */
const tbodyR = document.getElementById('tbodyReceitas');
const fmtBRL = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const norm = s => String(s||'').trim().toLowerCase();
const FACTOR = { g:1, kg:1000, ml:1, l:1000, un:1 };
const TYPE   = u => (u==='g'||u==='kg')?'mass' : (u==='ml'||u==='l')?'vol' : 'count';
function convertQty(qty, from, to){
  from=(from||'').toLowerCase(); to=(to||'').toLowerCase();
  if(!FACTOR[from]||!FACTOR[to]) return qty;
  if(TYPE(from)!==TYPE(to)) return NaN;
  return qty*(FACTOR[from]/FACTOR[to]);
}
function qtyUmFrom(r){
  const qtd = Number(r.qtd ?? r.quantidade ?? r.qtdReceita ?? 0);
  const um  = String(r.um ?? r.unidade ?? r.unidadeReceita ?? '').toLowerCase();
  return {qtd, um};
}
function driveImgSrc(uOrId, size=800){
  if(!uOrId) return '';
  const s = String(uOrId);
  let id = '';
  const m1 = s.match(/\/d\/([^/]+)/);
  const m2 = s.match(/[?&]id=([^&]+)/);
  if (m1 && m1[1]) id = m1[1];
  else if (m2 && m2[1]) id = m2[1];
  else if (/^[a-zA-Z0-9_-]{20,}$/.test(s)) id = s;
  if(!id) return s;
  return `https://drive.google.com/thumbnail?id=${id}&sz=w${size}`;
}

/* ===== GAS ===== */
async function apiGet(path){
  const r = await fetch(WEBAPP_URL+path, {cache:'no-store'});
  return r.json();
}

/* Carrega empresas = união (Produtos ∪ Ingredientes) e ingredientes */
async function carregarEmpresas(){
  try{
    const [p,i] = await Promise.all([
      apiGet('?action=produtos&ts='+Date.now()),
      apiGet('?action=ingredientes&ts='+Date.now())
    ]);
    const set = new Set();
    if(p.ok) (p.data||[]).forEach(r=> r.empresa && set.add(r.empresa));
    if(i.ok) (i.data||[]).forEach(r=> r.empresa && set.add(r.empresa));
    EMPRESAS = [...set];
    ING_TODOS = i.ok ? (i.data||[]) : [];
    return;
  }catch(_){}
  EMPRESAS = [];
  ING_TODOS = [];
}

async function carregarDados(){
  const p = await apiGet('?action=produtos&ts='+Date.now());
  PRODUTOS = p.ok ? (p.data||[]) : [];
}

/* ===== RENDER LISTA ===== */
function renderEmpresasSelect(){
  const sel = document.getElementById('fEmpresa');
  sel.innerHTML = '<option value="">(Todas)</option>' + EMPRESAS.map(e=>`<option value="${e}">${e}</option>`).join('');
  if(EMPRESA_ATUAL){ sel.value = EMPRESA_ATUAL; }
}
function renderTabela(){
  const busca = norm(document.getElementById('fBusca').value);
  const emp = document.getElementById('fEmpresa').value;
  EMPRESA_ATUAL = emp;

  const arr = (PRODUTOS||[]).filter(r=>{
    const empOk = !emp || norm(r.empresa)===norm(emp);
    const bOk = !busca || [r.item,r.classificacao,r.codigoSistema,r.numero].some(v=> String(v||'').toLowerCase().includes(busca));
    return empOk && bOk;
  });

  tbodyR.innerHTML = '';
  arr.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="tag">${r.empresa||'-'}</span></td>
      <td>${r.codigoSistema||''}</td>
      <td>${r.numero||''}</td>
      <td><span class="link" data-idx="${idx}">${r.item||''}</span></td>
      <td>${r.classificacao||''}</td>
      <td>${r.rendimento||''}</td>
      <td>${(r.unidadeRend||'').toUpperCase()}</td>
      <td class="right">${fmtBRL(Number(r.custoReceita||0))}</td>
      <td class="right">${fmtBRL(Number(r.custoPorKgOuL||0))}</td>
      <td>${r.data||''}</td>
      <td>${r.usuario||''}</td>`;
    tbodyR.appendChild(tr);
  });

  tbodyR.querySelectorAll('.link').forEach(a=> a.addEventListener('click', (e)=>{
    const idx = Number(e.target.dataset.idx);
    const listaFiltrada = (PRODUTOS||[]).filter(r=>{
      const empOk = !EMPRESA_ATUAL || norm(r.empresa)===norm(EMPRESA_ATUAL);
      const b = norm(document.getElementById('fBusca').value);
      const bOk = !b || [r.item,r.classificacao,r.codigoSistema,r.numero].some(v=> String(v||'').toLowerCase().includes(b));
      return empOk && bOk;
    });
    const item = listaFiltrada[idx];
    if(item) abrirModal(item);
  }));

  document.getElementById('metaInfo').textContent = `${arr.length} receitas exibidas${emp?` • Empresa: ${emp}`:''}`;
}

/* ===== ÍNDICE DE INGREDIENTES (cliente) ===== */
function buildIngIndex(){
  const map = {}; // map[empresa][key] = ingrediente
  (ING_TODOS||[]).forEach(x=>{
    const emp = x.empresa||''; if(!map[emp]) map[emp]={};
    const keyCod  = x.codigo ? `#${String(x.codigo).trim()}` : null;
    const keyNome = `n:${norm(x.nome)}`;
    if(keyCod) map[emp][keyCod] = x;
    map[emp][keyNome] = x;
  });
  return map;
}
function acharIng(map, empresa, recItem){
  const keyCod = recItem.codigo ? `#${String(recItem.codigo).trim()}` : null;
  const keyNome = `n:${norm(recItem.item)}`;
  const m = map[empresa]||{};
  return (keyCod && m[keyCod]) || m[keyNome] || null;
}

/* ===== MODAL ===== */
const modal = document.getElementById('modal');
document.getElementById('mFechar').addEventListener('click', ()=> modal.style.display='none');

/* Tenta comparar via API; se não tiver, compara localmente com ING_TODOS */
async function compararViaAPI(rec){
  try{
    const {qtd, um} = qtyUmFrom(rec);
    const codigo = rec.codigo ? `codigo=${encodeURIComponent(rec.codigo)}` : '';
    const nome   = !rec.codigo ? `nome=${encodeURIComponent(rec.item||'')}` : '';
    const qs = (codigo || nome) + `&qtd=${encodeURIComponent(qtd||0)}&um=${encodeURIComponent(um)}`;
    const j = await apiGet(`?action=comparar_ingrediente&${qs}&ts=${Date.now()}`);
    if(j && j.ok) return j.data;
  }catch(_){}
  return null;
}
function compararLocal(rec){
  const {qtd, um} = qtyUmFrom(rec);
  const idx = buildIngIndex();
  const empresas = EMPRESAS.map(emp=>{
    const ing = acharIng(idx, emp, rec);
    if(!ing) return null;
    const umPreco = String(ing.um||'').toLowerCase();
    const conv = (qtd>0 && um) ? convertQty(qtd, um, umPreco) : null;
    const custo = Number(ing.custoUnit||0);
    const subtotal = (conv===null || isNaN(conv)) ? null : conv * custo;
    return {
      empresa: emp,
      codigo: ing.codigo||'',
      nome:   ing.nome||'',
      umPreco,
      custoUnit: custo,
      qtdConvertida: (conv===null||isNaN(conv))?null:conv,
      subtotal: (subtotal===null||isNaN(subtotal))?null:Number(subtotal.toFixed(6))
    };
  }).filter(Boolean);
  let idxBarato=-1, menor=Infinity;
  empresas.forEach((x,i)=>{ if(typeof x.custoUnit==='number' && x.custoUnit<menor){ menor=x.custoUnit; idxBarato=i; }});
  return { chave: rec.codigo ? {tipo:'codigo', valor:rec.codigo} : {tipo:'nome', valor:rec.item||''},
           qtd, umReceita: um, empresas, idxMaisBarata: idxBarato };
}

async function abrirModal(prod){
  const baseEmp = prod.empresa || EMPRESA_ATUAL || '';

  // Select de comparação (padrão = Todas)
  const cmpSel = document.getElementById('mCompare');
  const opts = ['<option value="__ALL__">(Todas)</option>'].concat(EMPRESAS.map(e=>`<option value="${e}">${e}</option>`));
  cmpSel.innerHTML = opts.join('');
  cmpSel.value = '__ALL__';

  async function fetchComparativo(rec){
    const viaAPI = await compararViaAPI(rec);
    if(viaAPI) return viaAPI;
    return compararLocal(rec);
  }

  async function render(){
    const val = cmpSel.value;
    let empresasToShow = val==='__ALL__' ? [...EMPRESAS] : [val];
    if(!empresasToShow.includes(baseEmp)) empresasToShow.unshift(baseEmp);

    document.getElementById('mTitulo').textContent = `${prod.item||''}`;
    document.getElementById('mSub').textContent = `${prod.classificacao||''} • Empresa base: ${baseEmp} • Nº ${prod.numero||''}`;

    // Foto do produto
    const fotoEl = document.getElementById('mFoto');
    fotoEl.referrerPolicy = 'no-referrer';
    let fotoSrc = driveImgSrc(prod.fotoUrl || prod.fotoId, 800);
    if(!prod.fotoUrl && !prod.fotoId){
      const cand = (PRODUTOS||[]).find(p =>
        (p.codigoSistema && p.codigoSistema===prod.codigoSistema && p.fotoUrl) ||
        (p.item && norm(p.item)===norm(prod.item) && p.fotoUrl)
      );
      if(cand && cand.fotoUrl) fotoSrc = driveImgSrc(cand.fotoUrl, 800);
    }
    if(fotoSrc){ fotoEl.onerror=()=>{fotoEl.style.display='none'}; fotoEl.src=fotoSrc; fotoEl.style.display='block'; }
    else { fotoEl.style.display='none'; }

    const receita = Array.isArray(prod.receita) ? prod.receita : [];
    const thead = document.getElementById('theadDet');
    const tbody = document.getElementById('tbodyDet');
    thead.innerHTML = '';
    tbody.innerHTML = '';

    const thCols = ['Ingrediente','Qtd (receita)','U.M.'].concat(empresasToShow.map(e=>`Preço • ${e}`));
    const trH = document.createElement('tr');
    thCols.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; if(h.startsWith('Preço')) th.className='right'; trH.appendChild(th); });
    thead.appendChild(trH);

    const totais = {}; empresasToShow.forEach(e=> totais[e]=0);

    const comps = await Promise.all(receita.map(r=>fetchComparativo(r)));

    receita.forEach((r, idx)=>{
      const comp = comps[idx];
      const {qtd, um} = qtyUmFrom(r);
      const porEmpresa = (comp?.empresas||[]).filter(x=> empresasToShow.includes(x.empresa));

      const validos = porEmpresa.filter(x=> x.subtotal!=null);
      const minVal = validos.length ? Math.min(...validos.map(x=>x.subtotal)) : null;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.item||''}${r.codigo?` <span class="small muted">(cod: ${r.codigo})</span>`:''}${!comp?' <span class="small muted">• sem cadastro</span>':''}</td>
        <td class="right">${Number(qtd||0)}</td>
        <td>${(um||'').toUpperCase()}</td>
      `;

      empresasToShow.forEach(emp=>{
        const x = porEmpresa.find(e=> e.empresa===emp);
        const td = document.createElement('td'); td.className='right';
        if(!x){
          td.textContent='—';
          td.title = comp ? 'Sem cadastro desta empresa para este ingrediente' : 'Ingrediente não encontrado';
        }else{
          if(x.subtotal!=null) totais[emp]+=x.subtotal;
          td.title = (x.qtdConvertida==null)
            ? `Sem conversão (unidades incompatíveis)`
            : `Conversão: ${qtd} ${(um||'').toLowerCase()} → ${x.qtdConvertida.toFixed(4)} ${x.umPreco} • subtotal = ${x.qtdConvertida.toFixed(4)} × ${fmtBRL(x.custoUnit)}`;
          td.textContent = (x.subtotal==null)
            ? `${fmtBRL(x.custoUnit)} • —`
            : `${fmtBRL(x.custoUnit)} • ${fmtBRL(x.subtotal)}`;
          if(minVal!=null && x.subtotal===minVal) td.classList.add('best');
        }
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    const totalsWrap = document.getElementById('mTotals');
    totalsWrap.innerHTML = '';
    empresasToShow.forEach(emp=>{
      const div = document.createElement('div');
      div.style.gridColumn = 'span 6';
      div.innerHTML = `<span class="pill">Total na empresa (${emp}): <strong>${fmtBRL(totais[emp]||0)}</strong></span>`;
      totalsWrap.appendChild(div);
    });

    document.getElementById('mResumo').textContent =
      `Rendimento: ${prod.rendimento||''} ${(prod.unidadeRend||'').toUpperCase()} • Itens: ${Array.isArray(prod.receita)?prod.receita.length:0}`;

    document.getElementById('mExplain').textContent =
      'Os preços vêm do cadastro de ingredientes. A quantidade da receita é convertida para a U.M. do preço (kg↔g, L↔ml, un 1:1). A célula destacada (💚) indica onde o subtotal do ingrediente ficou menor.';
  }

  await render();
  document.getElementById('mCompare').onchange = render;
  modal.style.display='flex';
}

/* ===== BOOT ===== */
async function boot(){
  const btn = document.getElementById('btnAtualizar');
  btn.disabled = true; btn.textContent = 'Carregando...';
  await carregarEmpresas();
  await carregarDados();
  renderEmpresasSelect();
  renderTabela();
  btn.disabled = false; btn.textContent = 'Atualizar';
}
document.getElementById('btnAtualizar').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnAtualizar');
  btn.disabled = true; btn.textContent = 'Atualizando...';
  await carregarEmpresas();
  await carregarDados();
  renderEmpresasSelect();
  renderTabela();
  btn.disabled = false; btn.textContent = 'Atualizar';
});
document.getElementById('fEmpresa').addEventListener('change', renderTabela);
document.getElementById('fBusca').addEventListener('input', renderTabela);
boot();
</script>
</body>
</html>
