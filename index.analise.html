<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel de An√°lise ‚Ä¢ Receitas</title>
<style>
  :root{ --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f0f0f0; --muted:#cfcfcf; --brand:#2563eb; --ghost:#374151; --accent:#b75507; }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:24px}
  h1{margin:0 0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 4px 20px rgba(0,0,0,.3)}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  label{font-size:.85rem;color:var(--muted)}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#0f0f10;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
  th{background:#000}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;background:var(--brand);color:#fff}
  .btn.ghost{background:transparent;border:1px solid var(--ghost)}
  .right{text-align:right}
  .muted{opacity:.85}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--ghost);font-size:.8rem;background:#111}
  .small{font-size:.9rem}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f172a;border:1px solid #334155;color:#cbd5e1;font-size:.75rem}
  .link{cursor:pointer;color:#93c5fd}

  /* destaque melhor pre√ßo */
  .best{outline:2px solid #16a34a; background:rgba(22,163,74,.12)}
  .best::after{content:" üíö";}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{width:100%;max-width:1100px;max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}

  /* Cabe√ßalho do modal: t√≠tulo | foto+select | fechar (larguras iguais p/ select e bot√£o) */
  .modal header{
    display:grid;
    grid-template-columns: 1fr auto auto;
    align-items:center;
    gap:12px;
    margin-bottom:8px
  }
  .h-mid{display:flex;align-items:center;gap:10px}
  .ctrl{height:40px; padding:10px 14px; border-radius:12px}
  .ctrl.w{width:220px}
  .foto{width:56px;height:56px;object-fit:cover;border-radius:12px;border:1px solid var(--line)}

  .tbl-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
  .center{display:flex;align-items:center;gap:8px}

  @media (max-width: 768px){
    body{padding:12px}
    .row{grid-template-columns:1fr;gap:10px}
    .modal header{grid-template-columns: 1fr; gap:8px}
    .h-right{display:flex;justify-content:flex-end}
    .ctrl.w{width:100%}
  }
</style>
</head>
<body>
  <h1>Painel de An√°lise de Receitas</h1>

  <div class="card">
    <div class="row">
      <div style="grid-column: span 3">
        <label>Empresa</label>
        <select id="fEmpresa"><option value="">(Todas)</option></select>
      </div>
      <div style="grid-column: span 5">
        <label>Buscar</label>
        <input id="fBusca" placeholder="Item, classifica√ß√£o, c√≥digo...">
      </div>
      <div style="grid-column: span 2;align-self:end" class="right">
        <button class="btn ghost" id="btnAtualizar">Atualizar</button>
      </div>
    </div>
    <div id="metaInfo" class="small muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <table id="tblReceitas">
      <thead>
        <tr>
          <th>Empresa</th><th>C√≥digo</th><th>N¬∫</th><th>Item</th><th>Classifica√ß√£o</th>
          <th>Rendimento</th><th>U.M.</th><th class="right">Custo da Receita</th>
          <th class="right">Custo por kg/L</th><th>Data</th><th>Usu√°rio</th>
        </tr>
      </thead>
      <tbody id="tbodyReceitas"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="box">
      <header>
        <div>
          <div id="mTitulo" style="font-weight:700;font-size:1.1rem"></div>
          <div id="mSub" class="small muted"></div>
        </div>
        <div class="h-mid">
          <img id="mFoto" class="foto" alt="foto" style="display:none"/>
          <div>
            <label class="small" for="mCompare">Empresas</label><br/>
            <select id="mCompare" class="ctrl w"></select>
          </div>
        </div>
        <div class="h-right">
          <button class="btn ghost ctrl w" id="mFechar">Fechar</button>
        </div>
      </header>

      <div id="mResumo" class="pill" style="margin-bottom:12px"></div>

      <div class="tbl-wrap">
        <table id="tblDet">
          <thead id="theadDet"></thead>
          <tbody id="tbodyDet"></tbody>
        </table>
      </div>

      <div id="mTotals" class="row" style="margin-top:12px"></div>
      <div id="mExplain" class="small muted" style="margin-top:6px"></div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzgAtK2XHB9l4Ddmx9tNAR-xEl194w-wwQE2kNxbVUl4ZqrOytTWJeuyXau35Qhs-e1/exec';

/* ===== ESTADO ===== */
let PRODUTOS = [];
let EMPRESAS = [];
let EMPRESA_ATUAL = '';

/* ===== HELPERS ===== */
const tbodyR = document.getElementById('tbodyReceitas');
const fmtBRL = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const norm = s => String(s||'').trim().toLowerCase();

function driveImgSrc(uOrId){
  if(!uOrId) return '';
  if(/^[a-zA-Z0-9_-]{20,}$/.test(uOrId)) return `https://drive.google.com/uc?export=view&id=${uOrId}`;
  const m = String(uOrId).match(/\/d\/([^/]+)/) || String(uOrId).match(/[?&]id=([^&]+)/);
  const id = m && m[1];
  return id ? `https://drive.google.com/uc?export=view&id=${id}` : uOrId;
}
function qtyUmFrom(r){
  const qtd = Number(r.qtd ?? r.quantidade ?? r.qtdReceita ?? 0);
  const um  = String(r.um ?? r.unidade ?? r.unidadeReceita ?? '').toLowerCase();
  return {qtd, um};
}

/* ===== GAS ===== */
async function apiGet(path){
  const r = await fetch(WEBAPP_URL+path, {cache:'no-store'});
  return r.json();
}
async function carregarEmpresas(){
  try{
    const j = await apiGet('?action=empresas&ts='+Date.now());
    if(j.ok && Array.isArray(j.data) && j.data.length){ EMPRESAS = j.data.filter(Boolean); return; }
  }catch(_){}
  const p = await apiGet('?action=produtos&ts='+Date.now());
  const set = new Set();
  if(p.ok) (p.data||[]).forEach(r=> r.empresa && set.add(r.empresa));
  EMPRESAS = [...set];
}
async function carregarDados(){
  const p = await apiGet('?action=produtos&ts='+Date.now());
  PRODUTOS = p.ok ? (p.data||[]) : [];
}

/* ===== RENDER LISTA ===== */
function renderEmpresasSelect(){
  const sel = document.getElementById('fEmpresa');
  sel.innerHTML = '<option value="">(Todas)</option>' + EMPRESAS.map(e=>`<option value="${e}">${e}</option>`).join('');
  if(EMPRESA_ATUAL){ sel.value = EMPRESA_ATUAL; }
}
function renderTabela(){
  const busca = norm(document.getElementById('fBusca').value);
  const emp = document.getElementById('fEmpresa').value;
  EMPRESA_ATUAL = emp;

  const arr = (PRODUTOS||[]).filter(r=>{
    const empOk = !emp || norm(r.empresa)===norm(emp);
    const bOk = !busca || [r.item,r.classificacao,r.codigoSistema,r.numero].some(v=> String(v||'').toLowerCase().includes(busca));
    return empOk && bOk;
  });

  tbodyR.innerHTML = '';
  arr.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="tag">${r.empresa||'-'}</span></td>
      <td>${r.codigoSistema||''}</td>
      <td>${r.numero||''}</td>
      <td><span class="link" data-idx="${idx}">${r.item||''}</span></td>
      <td>${r.classificacao||''}</td>
      <td>${r.rendimento||''}</td>
      <td>${(r.unidadeRend||'').toUpperCase()}</td>
      <td class="right">${fmtBRL(Number(r.custoReceita||0))}</td>
      <td class="right">${fmtBRL(Number(r.custoPorKgOuL||0))}</td>
      <td>${r.data||''}</td>
      <td>${r.usuario||''}</td>`;
    tbodyR.appendChild(tr);
  });

  tbodyR.querySelectorAll('.link').forEach(a=> a.addEventListener('click', (e)=>{
    const idx = Number(e.target.dataset.idx);
    const listaFiltrada = (PRODUTOS||[]).filter(r=>{
      const empOk = !EMPRESA_ATUAL || norm(r.empresa)===norm(EMPRESA_ATUAL);
      const b = norm(document.getElementById('fBusca').value);
      const bOk = !b || [r.item,r.classificacao,r.codigoSistema,r.numero].some(v=> String(v||'').toLowerCase().includes(b));
      return empOk && bOk;
    });
    const item = listaFiltrada[idx];
    if(item) abrirModal(item);
  }));

  document.getElementById('metaInfo').textContent = `${arr.length} receitas exibidas${emp?` ‚Ä¢ Empresa: ${emp}`:''}`;
}

/* ===== MODAL ===== */
const modal = document.getElementById('modal');
document.getElementById('mFechar').addEventListener('click', ()=> modal.style.display='none');

async function abrirModal(prod){
  const baseEmp = prod.empresa || EMPRESA_ATUAL || '';

  // Select de compara√ß√£o (padr√£o = Todas)
  const cmpSel = document.getElementById('mCompare');
  const opts = ['<option value="__ALL__">(Todas)</option>'].concat(EMPRESAS.map(e=>`<option value="${e}">${e}</option>`));
  cmpSel.innerHTML = opts.join('');
  cmpSel.value = '__ALL__';

  async function fetchComparativo(rec){ // usa preferencialmente o C√ìDIGO
    const {qtd, um} = qtyUmFrom(rec);
    const codigo = rec.codigo ? `codigo=${encodeURIComponent(rec.codigo)}` : '';
    const nome   = !rec.codigo ? `nome=${encodeURIComponent(rec.item||'')}` : '';
    const qs = (codigo || nome) + `&qtd=${encodeURIComponent(qtd||0)}&um=${encodeURIComponent(um)}`;
    const j = await apiGet(`?action=comparar_ingrediente&${qs}&ts=${Date.now()}`);
    return j.ok ? j.data : null;
  }

  async function render(){
    const val = cmpSel.value;
    let empresasToShow = val==='__ALL__' ? [...EMPRESAS] : [val];
    if(!empresasToShow.includes(baseEmp)) empresasToShow.unshift(baseEmp);

    document.getElementById('mTitulo').textContent = `${prod.item||''}`;
    document.getElementById('mSub').textContent = `${prod.classificacao||''} ‚Ä¢ Empresa base: ${baseEmp} ‚Ä¢ N¬∫ ${prod.numero||''}`;

    // Foto
    const foto = document.getElementById('mFoto');
    const src = driveImgSrc(prod.fotoUrl || prod.fotoId);
    if(src){ foto.onerror=()=>{foto.style.display='none'}; foto.src=src; foto.style.display='block'; }
    else { foto.style.display='none'; }

    const receita = Array.isArray(prod.receita) ? prod.receita : [];
    const thead = document.getElementById('theadDet');
    const tbody = document.getElementById('tbodyDet');
    thead.innerHTML = '';
    tbody.innerHTML = '';

    // Cabe√ßalho din√¢mico
    const thCols = ['Ingrediente','Qtd (receita)','U.M.'].concat(empresasToShow.map(e=>`Pre√ßo ‚Ä¢ ${e}`));
    const trH = document.createElement('tr');
    thCols.forEach(h=>{
      const th=document.createElement('th'); th.textContent=h;
      if(h.startsWith('Pre√ßo')) th.className='right';
      trH.appendChild(th);
    });
    thead.appendChild(trH);

    // Totais
    const totais = {}; empresasToShow.forEach(e=> totais[e]=0);

    // Comparativos (por item)
    const comps = await Promise.all(receita.map(r=>fetchComparativo(r)));

    receita.forEach((r, idx)=>{
      const comp = comps[idx];
      const {qtd, um} = qtyUmFrom(r);
      const porEmpresa = (comp?.empresas||[]).filter(x=> empresasToShow.includes(x.empresa));

      const validos = porEmpresa.filter(x=> x.subtotal!=null);
      const minVal = validos.length ? Math.min(...validos.map(x=>x.subtotal)) : null;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.item||''}${r.codigo?` <span class="small muted">(cod: ${r.codigo})</span>`:''}${!comp?' <span class="small muted">‚Ä¢ sem cadastro nas empresas</span>':''}</td>
        <td class="right">${Number(qtd||0)}</td>
        <td>${(um||'').toUpperCase()}</td>
      `;

      empresasToShow.forEach(emp=>{
        const x = porEmpresa.find(e=> e.empresa===emp);
        const td = document.createElement('td'); td.className='right';
        if(!x){
          td.textContent='‚Äî';
          td.title = comp ? 'Sem cadastro desta empresa para este ingrediente' : 'Ingrediente n√£o encontrado (verifique c√≥digo/nome)';
        }else{
          if(x.subtotal!=null) totais[emp]+=x.subtotal;
          td.title = (x.qtdConvertida==null)
            ? `Sem convers√£o (unidades incompat√≠veis)`
            : `Convers√£o: ${qtd} ${(um||'').toLowerCase()} ‚Üí ${x.qtdConvertida.toFixed(4)} ${x.umPreco} ‚Ä¢ subtotal = ${x.qtdConvertida.toFixed(4)} √ó ${fmtBRL(x.custoUnit)}`;
          td.textContent = (x.subtotal==null)
            ? `${fmtBRL(x.custoUnit)} ‚Ä¢ ‚Äî`
            : `${fmtBRL(x.custoUnit)} ‚Ä¢ ${fmtBRL(x.subtotal)}`;
          if(minVal!=null && x.subtotal===minVal) td.classList.add('best');
        }
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    // Totais por empresa
    const totalsWrap = document.getElementById('mTotals');
    totalsWrap.innerHTML = '';
    empresasToShow.forEach(emp=>{
      const div = document.createElement('div');
      div.style.gridColumn = 'span 6';
      div.innerHTML = `<span class="pill">Total na empresa (${emp}): <strong>${fmtBRL(totais[emp]||0)}</strong></span>`;
      totalsWrap.appendChild(div);
    });

    document.getElementById('mResumo').textContent =
      `Rendimento: ${prod.rendimento||''} ${(prod.unidadeRend||'').toUpperCase()} ‚Ä¢ Itens: ${Array.isArray(prod.receita)?prod.receita.length:0}`;

    document.getElementById('mExplain').textContent =
      'C√°lculo por empresa: convertemos a quantidade da receita para a unidade do pre√ßo do ingrediente (kg‚Üîg, L‚Üîml, un 1:1). '+
      'Subtotal = (quantidade convertida) √ó (pre√ßo unit√°rio da empresa). A c√©lula destacada (üíö) indica onde este ingrediente fica mais barato para a quantidade informada.';
  }

  await render();
  document.getElementById('mCompare').onchange = render;
  modal.style.display='flex';
}

/* ===== BOOT ===== */
async function boot(){
  const btn = document.getElementById('btnAtualizar');
  btn.disabled = true; btn.textContent = 'Carregando...';
  await carregarEmpresas();
  await carregarDados();
  renderEmpresasSelect();
  renderTabela();
  btn.disabled = false; btn.textContent = 'Atualizar';
}
document.getElementById('btnAtualizar').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnAtualizar');
  btn.disabled = true; btn.textContent = 'Atualizando...';
  await carregarDados(); renderTabela();
  btn.disabled = false; btn.textContent = 'Atualizar';
});
document.getElementById('fEmpresa').addEventListener('change', renderTabela);
document.getElementById('fBusca').addEventListener('input', renderTabela);
boot();
</script>
</body>
</html>
