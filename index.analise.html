<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel de An√°lise ‚Ä¢ Receitas</title>
<style>
  :root{ --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f0f0f0; --muted:#cfcfcf; --brand:#2563eb; --ghost:#374151; --accent:#b75507; }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:24px}
  h1{margin:0 0 16px}
  a{color:#93c5fd}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 4px 20px rgba(0,0,0,.3)}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  label{font-size:.85rem;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#0f0f10;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
  th{background:#000}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;background:var(--brand);color:#fff}
  .btn.ghost{background:transparent;border:1px solid var(--ghost)}
  .btn.secondary{background:#334155}
  .right{text-align:right}
  .muted{opacity:.85}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--ghost);font-size:.8rem;background:#111}
  .small{font-size:.9rem}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f172a;border:1px solid #334155;color:#cbd5e1;font-size:.75rem}
  .link{cursor:pointer;color:#93c5fd}

  /* Destaque melhor pre√ßo */
  .best{outline:2px solid #16a34a; background:rgba(22,163,74,.12)}
  .best::after{content:" üíö";}

  /* Modal de Detalhes */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{width:100%;max-width:1100px;max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .modal header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .foto{width:120px;height:120px;object-fit:cover;border-radius:12px;border:1px solid var(--line)}

  .tbl-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}

  /* mobile */
  @media (max-width: 768px){
    body{padding:12px}
    .row{grid-template-columns:1fr;gap:10px}
  }
</style>
</head>
<body>
  <h1>Painel de An√°lise de Receitas</h1>

  <div class="card">
    <div class="row">
      <div style="grid-column: span 3">
        <label>Empresa</label>
        <select id="fEmpresa"><option value="">(Todas)</option></select>
      </div>
      <div style="grid-column: span 5">
        <label>Buscar</label>
        <input id="fBusca" placeholder="Item, classifica√ß√£o, c√≥digo...">
      </div>
      <div style="grid-column: span 2;align-self:end" class="right">
        <button class="btn ghost" id="btnAtualizar">Atualizar</button>
      </div>
    </div>
    <div id="metaInfo" class="small muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <table id="tblReceitas">
      <thead>
        <tr>
          <th>Empresa</th>
          <th>C√≥digo</th>
          <th>N¬∫</th>
          <th>Item</th>
          <th>Classifica√ß√£o</th>
          <th>Rendimento</th>
          <th>U.M.</th>
          <th class="right">Custo da Receita</th>
          <th class="right">Custo por kg/L</th>
          <th>Data</th>
          <th>Usu√°rio</th>
        </tr>
      </thead>
      <tbody id="tbodyReceitas"></tbody>
    </table>
  </div>

  <!-- Modal Detalhes -->
  <div class="modal" id="modal">
    <div class="box">
      <header>
        <div>
          <div id="mTitulo" style="font-weight:700;font-size:1.1rem"></div>
          <div id="mSub" class="small muted"></div>
        </div>
        <div class="inline">
          <label class="small">Empresas</label>
          <select id="mCompare"></select>
          <button class="btn ghost" id="mFechar">Fechar</button>
        </div>
      </header>

      <div class="row" style="margin-bottom:12px">
        <div style="grid-column: span 9">
          <div class="pill" id="mResumo"></div>
        </div>
        <div style="grid-column: span 3" class="right">
          <img id="mFoto" class="foto" alt="foto" style="display:none"/>
        </div>
      </div>

      <div class="tbl-wrap">
        <table id="tblDet">
          <thead id="theadDet"></thead>
          <tbody id="tbodyDet"></tbody>
        </table>
      </div>

      <div id="mTotals" class="row" style="margin-top:12px"></div>
      <div id="mExplain" class="small muted" style="margin-top:6px"></div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyDhwp0hhF3wdQcq4krsXqBSCxgkE5qC_-21B0lwYgUnbvkt3w6TnUwhgZPiFDloWt2/exec';

/* ===== ESTADO ===== */
let PRODUTOS = [];
let ING_TODOS = [];
let EMPRESAS = [];
let EMPRESA_ATUAL = '';

/* ===== HELPERS ===== */
const tbodyR = document.getElementById('tbodyReceitas');
const fmtBRL = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

const FACTOR = { g:1, kg:1000, ml:1, l:1000, un:1 };
const TYPE   = u => (u==='g'||u==='kg')?'mass' : (u==='ml'||u==='l')?'vol' : 'count';
function convertQty(qty, from, to){
  from=(from||'').toLowerCase(); to=(to||'').toLowerCase();
  if(!FACTOR[from]||!FACTOR[to]) return qty;
  if(TYPE(from)!==TYPE(to)) return NaN;
  return qty*(FACTOR[from]/FACTOR[to]);
}
function norm(s){ return String(s||'').trim().toLowerCase(); }

/* Exibir imagens do Drive */
function driveImgSrc(uOrId){
  if(!uOrId) return '';
  if(/^[a-zA-Z0-9_-]{20,}$/.test(uOrId)) return `https://drive.google.com/uc?export=view&id=${uOrId}`;
  const m = String(uOrId).match(/\/d\/([^/]+)/) || String(uOrId).match(/[?&]id=([^&]+)/);
  const id = m && m[1];
  return id ? `https://drive.google.com/uc?export=view&id=${id}` : uOrId;
}

/* ===== GAS ===== */
async function apiGet(path){ const r = await fetch(WEBAPP_URL+path, {cache:'no-store'}); return r.json(); }
async function carregarEmpresas(){
  try{
    const j = await apiGet('?action=empresas&ts='+Date.now());
    if(j.ok && Array.isArray(j.data) && j.data.length){ EMPRESAS = j.data.filter(Boolean); return; }
  }catch(_){}
  const [p,i] = await Promise.all([ apiGet('?action=produtos&ts='+Date.now()), apiGet('?action=ingredientes&ts='+Date.now()) ]);
  const set = new Set();
  if(p.ok) (p.data||[]).forEach(r=>{ if(r.empresa) set.add(r.empresa); });
  if(i.ok) (i.data||[]).forEach(r=>{ if(r.empresa) set.add(r.empresa); });
  EMPRESAS = [...set];
}
async function carregarDados(){
  const [p,i] = await Promise.all([ apiGet('?action=produtos&ts='+Date.now()), apiGet('?action=ingredientes&ts='+Date.now()) ]);
  PRODUTOS = p.ok ? (p.data||[]) : [];
  ING_TODOS = i.ok ? (i.data||[]) : [];
}

/* ===== RENDER LISTA ===== */
function renderEmpresasSelect(){
  const sel = document.getElementById('fEmpresa');
  sel.innerHTML = '<option value="">(Todas)</option>' + EMPRESAS.map(e=>`<option value="${e}">${e}</option>`).join('');
  if(EMPRESA_ATUAL){ sel.value = EMPRESA_ATUAL; }
}
function renderTabela(){
  const busca = norm(document.getElementById('fBusca').value);
  const emp = document.getElementById('fEmpresa').value;
  EMPRESA_ATUAL = emp;
  const arr = (PRODUTOS||[]).filter(r=>{
    const empOk = !emp || norm(r.empresa)===norm(emp);
    const bOk = !busca || [r.item,r.classificacao,r.codigoSistema,r.numero].some(v=> String(v||'').toLowerCase().includes(busca));
    return empOk && bOk;
  });
  tbodyR.innerHTML = '';
  arr.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="tag">${r.empresa||'-'}</span></td>
      <td>${r.codigoSistema||''}</td>
      <td>${r.numero||''}</td>
      <td><span class="link" data-idx="${idx}">${r.item||''}</span></td>
      <td>${r.classificacao||''}</td>
      <td>${r.rendimento||''}</td>
      <td>${(r.unidadeRend||'').toUpperCase()}</td>
      <td class="right">${fmtBRL(Number(r.custoReceita||0))}</td>
      <td class="right">${fmtBRL(Number(r.custoPorKgOuL||0))}</td>
      <td>${r.data||''}</td>
      <td>${r.usuario||''}</td>`;
    tbodyR.appendChild(tr);
  });
  tbodyR.querySelectorAll('.link').forEach(a=> a.addEventListener('click', (e)=>{
    const idx = Number(e.target.dataset.idx);
    const listaFiltrada = (PRODUTOS||[]).filter(r=>{
      const empOk = !EMPRESA_ATUAL || norm(r.empresa)===norm(EMPRESA_ATUAL);
      const bOk = !norm(document.getElementById('fBusca').value) ||
        [r.item,r.classificacao,r.codigoSistema,r.numero].some(v=> String(v||'').toLowerCase().includes(norm(document.getElementById('fBusca').value)));
      return empOk && bOk;
    });
    const item = listaFiltrada[idx];
    if(item) abrirModal(item);
  }));
  document.getElementById('metaInfo').textContent = `${arr.length} receitas exibidas${emp?` ‚Ä¢ Empresa: ${emp}`:''}`;
}

/* ===== COMPARA√á√ÉO ===== */
function indexIngredientesPorEmpresa(){
  const map = {};
  (ING_TODOS||[]).forEach(x=>{
    const emp = x.empresa||''; if(!map[emp]) map[emp] = {};
    const key = x.codigo ? `#${String(x.codigo).trim()}` : `n:${norm(x.nome)}`;
    map[emp][key] = x;
  });
  return map;
}
function acharIng(map, empresa, recItem){
  const keyCod = recItem.codigo ? `#${String(recItem.codigo).trim()}` : null;
  const keyNome = `n:${norm(recItem.item)}`;
  const m = map[empresa]||{};
  return (keyCod && m[keyCod]) || m[keyNome] || null;
}

/* ===== MODAL ===== */
const modal = document.getElementById('modal');
const mFechar = document.getElementById('mFechar');
mFechar.addEventListener('click', ()=> modal.style.display='none');

function abrirModal(prod){
  const map = indexIngredientesPorEmpresa();
  const baseEmp = prod.empresa || EMPRESA_ATUAL || '';

  // popula select (padr√£o = Todas)
  const cmpSel = document.getElementById('mCompare');
  const opts = ['<option value="__ALL__">(Todas)</option>']
    .concat(EMPRESAS.map(e=>`<option value="${e}">${e}</option>`));
  cmpSel.innerHTML = opts.join('');
  cmpSel.value = '__ALL__';

  function render(){
    // quais empresas mostrar
    const val = cmpSel.value;
    let empresasToShow = val==='__ALL__' ? [...EMPRESAS] : [val];
    // garante que a empresa base tamb√©m apare√ßa (se n√£o estiver na lista)
    if(!empresasToShow.includes(baseEmp)) empresasToShow.unshift(baseEmp);

    document.getElementById('mTitulo').textContent = `${prod.item||''}`;
    document.getElementById('mSub').textContent = `${prod.classificacao||''} ‚Ä¢ Empresa base: ${baseEmp} ‚Ä¢ N¬∫ ${prod.numero||''}`;

    const foto = document.getElementById('mFoto');
    const src = driveImgSrc(prod.fotoId || prod.fotoUrl);
    if(src){ foto.onerror=()=>{foto.style.display='none'}; foto.src=src; foto.style.display='block'; }
    else { foto.style.display='none'; }

    const receita = Array.isArray(prod.receita) ? prod.receita : [];
    const thead = document.getElementById('theadDet');
    const tbody = document.getElementById('tbodyDet');
    thead.innerHTML = '';
    tbody.innerHTML = '';

    // Cabe√ßalho din√¢mico
    const thCols = ['Ingrediente','Qtd (receita)','U.M.'].concat(empresasToShow.map(e=>`Pre√ßo ‚Ä¢ ${e}`));
    const trH = document.createElement('tr');
    thCols.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; if(h.startsWith('Pre√ßo')) th.className='right'; trH.appendChild(th); });
    thead.appendChild(trH);

    // Totais por empresa
    const totais = {}; empresasToShow.forEach(e=> totais[e]=0);

    // Linhas
    receita.forEach(r=>{
      // para cada empresa, calcula unit/subtotal considerando convers√£o
      const porEmpresa = empresasToShow.map(emp=>{
        const ing = acharIng(map, emp, r);
        if(!ing) return {emp, unit:null, subtotal:null, umPreco:null, convTxt:'Sem cadastro'};
        const umPreco = String(ing.um||'').toLowerCase();
        const umLinha = String(r.um||'').toLowerCase();
        const qtd = Number(r.qtd||0);
        const qConv = convertQty(qtd, umLinha, umPreco);
        const unit = Number(ing.custoUnit||0);
        const sub = (isNaN(qConv)?0:qConv)*unit;
        if(!isNaN(sub)) totais[emp]+=sub;
        const convTxt = isNaN(qConv)
          ? `Unidades incompat√≠veis (${umLinha} ‚Üí ${umPreco})`
          : `Convers√£o: ${qtd} ${umLinha} ‚Üí ${qConv.toFixed(4)} ${umPreco} ‚Ä¢ subtotal = ${qConv.toFixed(4)} √ó ${fmtBRL(unit)}`;
        return {emp, unit, subtotal: isNaN(sub)?null:sub, umPreco, convTxt};
      });

      // descobre o menor subtotal dispon√≠vel
      const validos = porEmpresa.filter(x=>x.subtotal!=null);
      const minVal = validos.length ? Math.min(...validos.map(x=>x.subtotal)) : null;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.item||''}</td>
        <td class="right">${Number(r.qtd||0)}</td>
        <td>${(r.um||'').toUpperCase()}</td>
      `;
      porEmpresa.forEach(obj=>{
        const td = document.createElement('td');
        td.className = 'right';
        if(obj.subtotal==null){
          td.textContent = '‚Äî';
          td.title = obj.convTxt || '';
        }else{
          td.title = obj.convTxt || '';
          td.textContent = `${fmtBRL(obj.unit)} ‚Ä¢ ${fmtBRL(obj.subtotal)}`;
          if(minVal!=null && obj.subtotal===minVal) td.classList.add('best');
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    // Totais (pills)
    const totalsWrap = document.getElementById('mTotals');
    totalsWrap.innerHTML = '';
    empresasToShow.forEach(emp=>{
      const div = document.createElement('div');
      div.style.gridColumn = 'span 6';
      div.innerHTML = `<span class="pill">Total na empresa (${emp}): <strong>${fmtBRL(totais[emp]||0)}</strong></span>`;
      totalsWrap.appendChild(div);
    });

    document.getElementById('mResumo').textContent =
      `Rendimento: ${prod.rendimento||''} ${(prod.unidadeRend||'').toUpperCase()} ‚Ä¢ Itens: ${Array.isArray(prod.receita)?prod.receita.length:0}`;

    document.getElementById('mExplain').textContent =
      'C√°lculo: para cada empresa, convertemos a quantidade da receita para a unidade do pre√ßo do ingrediente (kg‚Üîg, L‚Üîml, un 1:1). '+
      'F√≥rmula do subtotal por empresa: subtotal = (quantidade convertida) √ó (pre√ßo unit√°rio da empresa). '+
      'A c√©lula destacada (üíö) indica em qual empresa aquele ingrediente est√° mais barato para a quantidade da receita.';
  }

  render();
  document.getElementById('mCompare').onchange = render;
  modal.style.display='flex';
}

/* ===== BOOT ===== */
async function boot(){
  const btn = document.getElementById('btnAtualizar');
  btn.disabled = true; btn.textContent = 'Carregando...';
  await carregarEmpresas();
  await carregarDados();
  renderEmpresasSelect();
  renderTabela();
  btn.disabled = false; btn.textContent = 'Atualizar';
}

// Eventos filtros
document.getElementById('btnAtualizar').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnAtualizar');
  btn.disabled = true; btn.textContent = 'Atualizando...';
  await carregarDados(); renderTabela();
  btn.disabled = false; btn.textContent = 'Atualizar';
});
document.getElementById('fEmpresa').addEventListener('change', renderTabela);
document.getElementById('fBusca').addEventListener('input', renderTabela);

boot();
</script>
</body>
</html>
